@echo off
REM ====================================================================
REM VERIFY_HEALTHAPP_ALLERGEN.bat - Verificare HealthApp Allergen Detection
REM ====================================================================

echo.
echo üîç HEALTHAPP ALLERGEN DETECTION - VERIFICATION
echo ===============================================
echo.

set PROJECT_ROOT=E:\Projects\HealthApp\healthapp
set ALL_GOOD=true

REM VerificƒÉ cƒÉ suntem √Æn directorul corect
if not exist "%PROJECT_ROOT%\lib" (
    echo ‚ùå ERROR: HealthApp not found at %PROJECT_ROOT%
    pause
    exit /b 1
)

cd /d "%PROJECT_ROOT%"
echo üìÅ Working Directory: %CD%
echo.

REM ====================================================================
REM 1. VERIFICƒÇ FI»òIERELE ESEN»öIALE
REM ====================================================================
echo üìÇ 1. CHECKING ESSENTIAL FILES...
echo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if exist "lib\models\allergen\allergen_match.dart" (
    echo ‚úÖ allergen_match.dart found
) else (
    echo ‚ùå MISSING: lib\models\allergen\allergen_match.dart
    set ALL_GOOD=false
)

if exist "lib\models\allergen\hybrid_detection_result.dart" (
    echo ‚úÖ hybrid_detection_result.dart found
) else (
    echo ‚ùå MISSING: lib\models\allergen\hybrid_detection_result.dart
    set ALL_GOOD=false
)

if exist "lib\services\hybrid_detection_service.dart" (
    echo ‚úÖ hybrid_detection_service.dart found
) else (
    echo ‚ùå MISSING: lib\services\hybrid_detection_service.dart
    set ALL_GOOD=false
)

if exist "pubspec.yaml" (
    echo ‚úÖ pubspec.yaml found
) else (
    echo ‚ùå MISSING: pubspec.yaml
    set ALL_GOOD=false
)

echo.

REM ====================================================================
REM 2. VERIFICƒÇ CON»öINUTUL FI»òIERELOR
REM ====================================================================
echo üß© 2. CHECKING FILE CONTENT...
echo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

REM VerificƒÉ AllergenMatch
if exist "lib\models\allergen\allergen_match.dart" (
    findstr /C:"class AllergenMatch" "lib\models\allergen\allergen_match.dart" >nul
    if errorlevel 1 (
        echo ‚ùå AllergenMatch class NOT found in allergen_match.dart
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ AllergenMatch class found
    )
    
    REM VerificƒÉ cƒÉ nu este HybridDetectionResult √Æn acela»ôi fi»ôier
    findstr /C:"class HybridDetectionResult" "lib\models\allergen\allergen_match.dart" >nul
    if not errorlevel 1 (
        echo ‚ùå CONFLICT: HybridDetectionResult found in allergen_match.dart
        echo    ^(should be only in hybrid_detection_result.dart^)
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ No conflicting classes in allergen_match.dart
    )
    
    REM VerificƒÉ parametrul method
    findstr /C:"required this.method" "lib\models\allergen\allergen_match.dart" >nul
    if errorlevel 1 (
        echo ‚ùå AllergenMatch missing 'method' parameter
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ AllergenMatch has 'method' parameter
    )
) else (
    echo ‚ùå Cannot check allergen_match.dart - file missing
)

REM VerificƒÉ HybridDetectionResult
if exist "lib\models\allergen\hybrid_detection_result.dart" (
    findstr /C:"class HybridDetectionResult" "lib\models\allergen\hybrid_detection_result.dart" >nul
    if errorlevel 1 (
        echo ‚ùå HybridDetectionResult class NOT found
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ HybridDetectionResult class found
    )
    
    findstr /C:"import 'allergen_match.dart'" "lib\models\allergen\hybrid_detection_result.dart" >nul
    if errorlevel 1 (
        echo ‚ùå Missing import for AllergenMatch
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ Imports AllergenMatch correctly
    )
    
    findstr /C:"required this.metadata" "lib\models\allergen\hybrid_detection_result.dart" >nul
    if errorlevel 1 (
        echo ‚ùå Missing 'metadata' parameter
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ Has 'metadata' parameter
    )
) else (
    echo ‚ùå Cannot check hybrid_detection_result.dart - file missing
)

REM VerificƒÉ Service
if exist "lib\services\hybrid_detection_service.dart" (
    findstr /C:"class HybridDetectionService" "lib\services\hybrid_detection_service.dart" >nul
    if errorlevel 1 (
        echo ‚ùå HybridDetectionService class NOT found
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ HybridDetectionService class found
    )
    
    findstr /C:"detectAllergens" "lib\services\hybrid_detection_service.dart" >nul
    if errorlevel 1 (
        echo ‚ùå detectAllergens method NOT found
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ detectAllergens method found
    )
    
    findstr /C:"localhost:5000" "lib\services\hybrid_detection_service.dart" >nul
    if errorlevel 1 (
        echo ‚ö†Ô∏è  BERT API URL might not be configured
    ) else (
        echo ‚úÖ BERT API URL configured (localhost:5000)
    )
) else (
    echo ‚ùå Cannot check hybrid_detection_service.dart - file missing
)

echo.

REM ====================================================================
REM 3. VERIFICƒÇ DEPENDENCIES √éN PUBSPEC.YAML
REM ====================================================================
echo üì¶ 3. CHECKING FLUTTER DEPENDENCIES...
echo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if exist "pubspec.yaml" (
    findstr /C:"http:" "pubspec.yaml" >nul
    if errorlevel 1 (
        echo ‚ùå MISSING: http dependency
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ http dependency found
    )
    
    findstr /C:"provider:" "pubspec.yaml" >nul
    if errorlevel 1 (
        echo ‚ùå MISSING: provider dependency
        set ALL_GOOD=false
    ) else (
        echo ‚úÖ provider dependency found
    )
    
    REM Optional dependencies
    findstr /C:"camera:" "pubspec.yaml" >nul
    if errorlevel 1 (
        echo ‚ö†Ô∏è  OPTIONAL: camera dependency missing
    ) else (
        echo ‚úÖ camera dependency found (optional)
    )
    
    findstr /C:"google_mlkit_text_recognition:" "pubspec.yaml" >nul
    if errorlevel 1 (
        echo ‚ö†Ô∏è  OPTIONAL: google_mlkit_text_recognition missing
    ) else (
        echo ‚úÖ google_mlkit_text_recognition found (optional)
    )
) else (
    echo ‚ùå Cannot check dependencies - pubspec.yaml missing
)

echo.

REM ====================================================================
REM 4. VERIFICƒÇ PYTHON PENTRU BERT SERVER
REM ====================================================================
echo üêç 4. CHECKING PYTHON ENVIRONMENT...
echo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

python --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Python not found in PATH
    echo    Download from: https://python.org/downloads/
) else (
    for /f "tokens=2" %%i in ('python --version 2^>^&1') do echo ‚úÖ Python found: %%i
)

pip --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå pip not found in PATH
) else (
    echo ‚úÖ pip found
)

echo.

REM ====================================================================
REM 5. VERIFICƒÇ FLUTTER
REM ====================================================================
echo üì± 5. CHECKING FLUTTER...
echo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

flutter --version >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Flutter not found in PATH
    echo    Download from: https://flutter.dev/docs/get-started/install
) else (
    echo ‚úÖ Flutter found
)

echo.

REM ====================================================================
REM 6. CREEAZƒÇ TEST DE COMPILARE
REM ====================================================================
echo ‚öôÔ∏è  6. TESTING DART COMPILATION...
echo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

REM CreeazƒÉ un test simplu
echo // Test compilation > test_compilation_check.dart
echo import 'lib/models/allergen/allergen_match.dart'; >> test_compilation_check.dart
echo import 'lib/models/allergen/hybrid_detection_result.dart'; >> test_compilation_check.dart
echo import 'lib/services/hybrid_detection_service.dart'; >> test_compilation_check.dart
echo. >> test_compilation_check.dart
echo void main() { >> test_compilation_check.dart
echo   final service = HybridDetectionService(); >> test_compilation_check.dart
echo   service.initialize(); >> test_compilation_check.dart
echo   print('Compilation test OK'); >> test_compilation_check.dart
echo } >> test_compilation_check.dart

dart analyze test_compilation_check.dart >nul 2>&1
if errorlevel 1 (
    echo ‚ùå Dart compilation test FAILED
    echo    Run: dart analyze test_compilation_check.dart for details
    set ALL_GOOD=false
) else (
    echo ‚úÖ Dart compilation test PASSED
)

REM Cleanup
del test_compilation_check.dart >nul 2>&1

echo.

REM ====================================================================
REM REZULTAT FINAL
REM ====================================================================
echo üìã VERIFICATION SUMMARY
echo ======================

if "%ALL_GOOD%"=="true" (
    echo.
    echo üéâ ALL CRITICAL CHECKS PASSED!
    echo.
    echo ‚úÖ Ready for next steps:
    echo    1. Run: flutter pub get
    echo    2. Setup BERT server: run bert_server_setup.bat
    echo    3. Add provider to main.dart
    echo    4. Test the integration
    echo.
    echo üöÄ Your HealthApp Allergen Detection is READY!
    
) else (
    echo.
    echo ‚ùå SOME ISSUES FOUND!
    echo.
    echo ‚ö†Ô∏è  Common fixes needed:
    echo    ‚Ä¢ Remove duplicate classes from allergen_match.dart
    echo    ‚Ä¢ Add missing 'method' and 'metadata' parameters
    echo    ‚Ä¢ Add http and provider dependencies to pubspec.yaml
    echo    ‚Ä¢ Install Python 3 and Flutter SDK
    echo.
    echo üîß Fix these issues and run the script again.
)

echo.
echo üìû Need help? Check your file structure and imports.
echo.

pause